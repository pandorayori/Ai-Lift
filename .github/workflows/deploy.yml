name: Deploy to ECS

on:
  push:
    branches:
      - main   # 你就是用 main 分支

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取当前仓库代码（只是给 Actions 自己用）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 加载你刚才配好的 SSH 私钥（ECS_SSH_KEY）
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ECS_SSH_KEY }}

      # 3. 部署到 ECS：在服务器上 git pull + 构建 + 重启 pm2
      - name: Deploy to ECS
        run: |
          ssh -o StrictHostKeyChecking=no root@114.55.136.150 << 'EOF'
          set -e

          echo ">>> 进入项目目录"
          cd /root/apps/ai-lift-frontend

          echo ">>> 拉取最新代码"
          git pull origin main

          echo ">>> 安装依赖"
          npm install

          echo ">>> 构建前端"
          npm run build

          echo ">>> 使用 PM2 重启服务（已经在用 80 端口）"
          pm2 reload ai-lift-frontend || pm2 serve dist 80 --spa --name ai-lift-frontend

          echo ">>> 部署完成"
          EOF
